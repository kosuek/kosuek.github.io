<script>
    let personCount = 0;

    // ページが読み込まれたときに入力内容を復元
    window.onload = function() {
        loadHistory();  // 履歴を読み込む
        loadFormData(); // フォームのデータを復元
    }

    // 配送料を100の位で四捨五入する関数
    function roundToNearestHundred(value) {
        return Math.round(value / 100) * 100;
    }

    // 配送料の再現と100の位で四捨五入
    function loadFormData() {
        const formData = JSON.parse(localStorage.getItem('formData')) || { people: [] };
        formData.people.forEach(person => {
            addPerson(person.name, person.weight, person.totalPrice);
        });
        document.getElementById('shippingCost').value = formData.shippingCost || '';
        if (formData.shippingCost) {
            document.getElementById('shippingCost').value = roundToNearestHundred(formData.shippingCost);
        }
    }

    // 履歴をロードする関数
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('history')) || [];
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';  // 履歴を初期化
        history.forEach((item, index) => {
            const historyItemDiv = document.createElement('div');
            historyItemDiv.className = 'history-item';
            historyItemDiv.innerHTML = `
                <p>計算日: ${item.dateTimeString}</p>
                <p>合計金額: ${item.grandTotal} 円</p>
                ${item.peopleData.map(person => `
                    <p>${person.name}: ${person.totalIndividualCost} 円</p>
                `).join('')}
                <button class="btn btn-danger" onclick="deleteHistory(${index})">削除</button>
            `;
            historyList.appendChild(historyItemDiv);
        });
    }

    // 履歴を削除する関数
    function deleteHistory(index) {
        const history = JSON.parse(localStorage.getItem('history')) || [];
        history.splice(index, 1);
        localStorage.setItem('history', JSON.stringify(history));
        loadHistory();
    }

    // 計算を行う関数
    function calculate() {
        let totalWeight = 0;
        let totalCost = 0;
        const shippingCost = roundToNearestHundred(parseFloat(document.getElementById('shippingCost').value));

        for (let i = 1; i <= personCount; i++) {
            const personDiv = document.getElementById(`person${i}`);
            if (personDiv) {
                const weight = parseFloat(document.getElementById(`weight${i}`).value);
                const totalPrice = parseFloat(document.getElementById(`totalPrice${i}`).value);
                totalWeight += weight;
                totalCost += totalPrice;
            }
        }

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `<h2>計算結果</h2>`;
        let grandTotal = 0;

        const currentDate = new Date();
        const formattedDate = currentDate.toLocaleDateString('ja-JP');
        const formattedTime = currentDate.toLocaleTimeString('ja-JP');
        const dateTimeString = `${formattedDate} ${formattedTime}`;
        localStorage.setItem('lastCalculationDate', dateTimeString);

        let peopleData = [];
        for (let i = 1; i <= personCount; i++) {
            const personDiv = document.getElementById(`person${i}`);
            if (personDiv) {
                const name = document.getElementById(`name${i}`).value;
                const weight = parseFloat(document.getElementById(`weight${i}`).value);
                const totalPrice = parseFloat(document.getElementById(`totalPrice${i}`).value);
                const individualShippingCost = roundToNearestHundred((weight / totalWeight) * shippingCost);
                const totalIndividualCost = roundToNearestHundred(totalPrice + individualShippingCost);
                grandTotal += totalIndividualCost;

                peopleData.push({ name, totalIndividualCost });

                resultDiv.innerHTML += `
                    <p>${name}: お米代金: ${roundToNearestHundred(totalPrice)} 円, 配送料: ${individualShippingCost} 円, 合計: ${totalIndividualCost} 円</p>
                `;
            }
        }

        resultDiv.innerHTML += `<h3>全員の合計金額: ${grandTotal} 円</h3>`;
        resultDiv.innerHTML += `<p>計算日: ${dateTimeString}</p>`;

        // 履歴を保存
        const history = JSON.parse(localStorage.getItem('history')) || [];
        history.push({
            dateTimeString,
            grandTotal,
            peopleData
        });
        localStorage.setItem('history', JSON.stringify(history));

        // 履歴を再表示
        loadHistory();
    }

    // 履歴をテキストとしてコピーする
    function copyHistoryToText() {
        const history = JSON.parse(localStorage.getItem('history')) || [];
        const text = history.map(item => {
            return `計算日: ${item.dateTimeString}\n合計金額: ${item.grandTotal} 円\n` +
                item.peopleData.map(person => `${person.name}: ${person.totalIndividualCost} 円`).join('\n') +
                '\n';
        }).join('\n---\n');
        navigator.clipboard.writeText(text).then(() => {
            alert('履歴がコピーされました');
        });
    }

    // フォームデータを保存する関数
    function saveData() {
        const formData = {
            people: []
        };
        for (let i = 1; i <= personCount; i++) {
            const name = document.getElementById(`name${i}`).value;
            const weight = document.getElementById(`weight${i}`).value;
            const totalPrice = document.getElementById(`totalPrice${i}`).value;
            formData.people.push({ name, weight, totalPrice });
        }
        formData.shippingCost = document.getElementById('shippingCost').value;
        localStorage.setItem('formData', JSON.stringify(formData));
    }

    // フォームデータを復元する関数
    function loadFormData() {
        const formData = JSON.parse(localStorage.getItem('formData')) || { people: [] };
        formData.people.forEach(person => {
            addPerson(person.name, person.weight, person.totalPrice);
        });
        document.getElementById('shippingCost').value = formData.shippingCost || '';
    }
</script>
